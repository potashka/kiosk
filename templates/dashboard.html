<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <h1>Панель управления</h1>
        <div id="equipment-list">
            <!-- Список оборудования заполняется динамически через JavaScript -->
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const groupId = "{{ group_id }}";  // Используем переданный group_id
                fetch(`/equipment/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('equipment-list');
                    data.forEach(equipment => {
                        const item = document.createElement('div');
                        item.className = 'equipment-item ' + (equipment.active ? 'active' : 'inactive');
                        item.innerHTML = `
                            <span>${equipment.name}</span>
                            <button onclick="toggleEquipment(${equipment.id})">Переключить</button>
                            <button onclick="loadDowntimes(${equipment.id})">Простои</button>
                            <div id="downtimes-${equipment.id}" class="downtime-container"></div>
                        `;
                        list.appendChild(item);
                    });
                })
                .catch(error => console.error('Error loading equipment:', error));
            });

            function toggleEquipment(equipmentId) {
                fetch(`/toggle-equipment/${equipmentId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Статус оборудования успешно переключен!');
                        location.reload();  // Перезагрузка страницы для обновления статусов
                    } else {
                        throw new Error(data.message || 'Не удалось переключить статус оборудования');
                    }
                })
                .catch(error => console.error('Error toggling equipment:', error));
            }

            function loadDowntimes(equipmentId) {
                console.log(`Loading downtimes for equipment ID: ${equipmentId}`);
                fetch(`/downtimes/${equipmentId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Downtimes data:', data);
                    const container = document.getElementById(`downtimes-${equipmentId}`);
                    container.innerHTML = '';  // Clear previous entries
                    data.forEach(downtime => {
                        const entry = document.createElement('div');
                        entry.className = 'downtime-entry';
                        entry.id = `downtime-${JSON.stringify(downtime.id)}`;
                        entry.innerHTML = `
                            Start: ${downtime.start_id}, Stop: ${downtime.stop_id || 'Ongoing'}
                            <button onclick="showAnswers(${JSON.stringify(downtime.id)})">Update Reason</button>
                        `;
                        container.appendChild(entry);
                    });
                })
                .catch(error => console.error('Error loading downtimes:', error));
            }

            function showAnswers(downtimeId) {
                fetch(`/answers`)
                .then(response => response.json())
                .then(data => {
                    const selector = document.createElement('select');
                    data.forEach(answer => {
                        const option = document.createElement('option');
                        option.value = answer.answer_id;
                        option.text = answer.answer_text;
                        selector.appendChild(option);
                    });
                    selector.onchange = function() { updateDowntime(downtimeId, this.value); }
                    document.querySelector(`#downtime-${JSON.stringify(downtimeId)}`).appendChild(selector);
                })
                .catch(error => console.error('Error loading answers:', error));
            }

            function updateDowntime(downtimeId, answerId) {
                fetch(`/update-downtime/${downtimeId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({answer_id: answerId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Downtime updated successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to update downtime');
                    }
                })
                .catch(error => console.error('Error updating downtime:', error));
            }
        </script>
    </div>
</body>
</html>
