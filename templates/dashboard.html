<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <h1>Панель управления</h1>
        <div id="equipment-list">
            <!-- Список оборудования заполняется динамически через JavaScript -->
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const groupId = "{{ group_id }}";  // Используем переданный group_id
                fetch(`/equipment/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('equipment-list');
                    data.forEach(equipment => {
                        const item = document.createElement('div');
                        item.className = 'equipment-item ' + (equipment.active ? 'active' : 'inactive');
                        item.innerHTML = `
                            <span>${equipment.name}</span>
                            <button data-equipment-id="${equipment.id}" class="toggle-equipment">Переключить</button>
                            <button data-equipment-id="${equipment.id}" class="downtime-button">Простои</button>
                            <div id="downtimes-${equipment.id}" class="downtime-container"></div>
                        `;
                        list.appendChild(item);
                    });
                })
                .catch(error => console.error('Error loading equipment:', error));
            });

            document.addEventListener('click', function(event) {
                if (event.target.matches('.toggle-equipment')) {
                    toggleEquipment(event.target.getAttribute('data-equipment-id'));
                }
                if (event.target.matches('.downtime-button')) {
                    loadDowntimes(event.target.getAttribute('data-equipment-id'));
                }
            });

            function toggleEquipment(equipmentId) {
                fetch(`/toggle-equipment/${equipmentId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Статус оборудования успешно переключен!');
                        location.reload();  // Перезагрузка страницы для обновления статусов
                    } else {
                        throw new Error(data.message || 'Не удалось переключить статус оборудования');
                    }
                })
                .catch(error => console.error('Error toggling equipment:', error));
            }

            function loadDowntimes(equipmentId) {
                console.log(`Loading downtimes for equipment ID: ${equipmentId}`);
                fetch(`/downtimes/${equipmentId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById(`downtimes-${equipmentId}`);
                    if (container) {
                        container.style.display = data.length > 0 ? 'block' : 'none';
                        container.innerHTML = data.map(downtime => `
                            <div class='downtime-entry' id='downtime-${downtime.equipment_id}-${downtime.start_id}'>
                                <div>Начало: ${downtime.start_id || 'Unknown'}, Окончание простоя: ${downtime.stop_id || 'Продолжается'}</div>
                                <label for="reason-${downtime.equipment_id}-${downtime.start_id}">Выбрать причину простоя:</label>
                                <select id="reason-${downtime.equipment_id}-${downtime.start_id}" data-equipment-id="${downtime.equipment_id}" data-start-id="${downtime.start_id}">
                                    <option value="">------</option>
                                </select>
                            </div>
                        `).join('');
                        data.forEach(downtime => {
                            showAnswers(downtime.equipment_id, downtime.start_id);
                        });
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки простоев:', error);
                    if (container) {
                        container.style.display = 'none'; // Скрыть контейнер при ошибке
                    }
                });
            }

            function showAnswers(equipmentId, startId) {
                const selector = document.getElementById(`reason-${equipmentId}-${startId}`);
                if (!selector) {
                    console.error('Selector not found for ID:', `reason-${equipmentId}-${startId}`);
                    return;
                }

                fetch(`/answers`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(answer => {
                        const option = document.createElement('option');
                        option.value = answer.answer_id;
                        option.textContent = answer.answer_text;
                        selector.appendChild(option);
                    });
                    selector.onchange = () => { // Добавление обработчика события на изменение выбора
                        updateDowntime(equipmentId, startId, selector.value);
                    };
                })
                .catch(error => {
                    console.error('Error fetching answers:', error);
                });
            }

            function updateDowntime(equipmentId, startId, answerId) {
                console.log("Original answerId:", answerId); // Для проверки исходного значения
                const numericAnswerId = parseInt(answerId, 10);
                console.log("Converted numericAnswerId:", numericAnswerId);

                fetch(`/update-downtime/${equipmentId}/${startId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ answer_id: parseInt(answerId, 10) }) // Преобразование в число
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Данные о простое обнвлены!');
                    } else {
                        throw new Error(data.message || 'Данные о простое не обновились');
                    }
                })
                .catch(error => console.error('Error updating downtime:', error));
            }

            let idleTime = 0;

            function timerIncrement() {
                idleTime += 1;
                if (idleTime > 5) { // 5 минут бездействия
                    window.location.href = '/logout';
                }
            }

            // Обнуление таймера при действиях пользователя
            document.addEventListener('mousemove', resetTimer);
            document.addEventListener('keypress', resetTimer);

            function resetTimer() {
                idleTime = 0;
            }

            setInterval(timerIncrement, 60000); // Ежеминутная проверка
        </script>
    </div>
    <a href="/logout" class="home-button">На главную страницу</a>
</body>
</html>
