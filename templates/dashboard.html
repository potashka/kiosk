<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <h1>Панель управления</h1>
        <div id="equipment-list">
            <!-- Список оборудования заполняется динамически через JavaScript -->
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                const groupId = "{{ group_id }}";  // Используем переданный group_id
                fetch(`/equipment/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('equipment-list');
                    data.forEach(equipment => {
                        const item = document.createElement('div');
                        item.className = 'equipment-item ' + (equipment.active ? 'active' : 'inactive');
                        item.innerHTML = `
                            <span>${equipment.name}</span>
                            <button data-equipment-id="${equipment.id}" class="toggle-equipment">Переключить</button>
                            <button data-equipment-id="${equipment.id}" class="downtime-button">Простои</button>
                            <div id="downtimes-${equipment.id}" class="downtime-container"></div>
                        `;
                        list.appendChild(item);
                    });
                })
                .catch(error => console.error('Error loading equipment:', error));
            });

            document.addEventListener('click', function(event) {
                if (event.target.matches('.toggle-equipment')) {
                    toggleEquipment(event.target.getAttribute('data-equipment-id'));
                }
                if (event.target.matches('.downtime-button')) {
                    loadDowntimes(event.target.getAttribute('data-equipment-id'));
                }
            });

            function toggleEquipment(equipmentId) {
                fetch(`/toggle-equipment/${equipmentId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Статус оборудования успешно переключен!');
                        location.reload();  // Перезагрузка страницы для обновления статусов
                    } else {
                        throw new Error(data.message || 'Не удалось переключить статус оборудования');
                    }
                })
                .catch(error => console.error('Error toggling equipment:', error));
            }

            function loadDowntimes(equipmentId) {
                console.log(`Loading downtimes for equipment ID: ${equipmentId}`);
                fetch(`/downtimes/${equipmentId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById(`downtimes-${equipmentId}`);
                    if (container) {
                        container.style.display = data.length > 0 ? 'block' : 'none';
                        container.innerHTML = data.map(downtime => `
                            <div class='downtime-entry' id='downtime-${downtime.equipment_id}-${downtime.start_id}'>
                                Start: ${downtime.start_id}, Stop: ${downtime.stop_id || 'Ongoing'}
                                <button data-equipment-id="${downtime.equipment_id}" data-start-id="${downtime.start_id}" class="update-reason">Выбрать причину простоя</button>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error loading downtimes:', error);
                    if (container) {
                        container.style.display = 'none'; // Скрыть контейнер при ошибке
                    }
                });
            }           

            document.addEventListener('click', function(event) {
                if (event.target.matches('.update-reason')) {
                    showAnswers(event.target.getAttribute('data-equipment-id'), event.target.getAttribute('data-start-id'));
                }
            });
            function showAnswers(equipmentId, startId) {
                const containerId = `downtime-${equipmentId}-${startId}`;
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error('Container not found for ID:', containerId);
                    return;
                }
            
                // Очистка контейнера от предыдущего списка перед добавлением нового
                container.innerHTML = ''; 
            
                fetch(`/answers`)
                .then(response => response.json())
                .then(data => {
                    const selector = document.createElement('select');
                    // Добавление опции с прочерком по умолчанию
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "------";
                    selector.appendChild(defaultOption); // ДОБАВЛЕНО
                    selector.onchange = () => { // Добавление обработчика события на изменение выбора
                        updateDowntime(equipmentId, startId, selector.value);
                    };
                    data.forEach(answer => {
                        const option = document.createElement('option');
                        option.value = answer.answer_id;
                        option.textContent = answer.answer_text;
                        selector.appendChild(option);
                    });
                    container.appendChild(selector); // Добавление селектора в контейнер
                })
                .catch(error => {
                    console.error('Error fetching answers:', error);
                });
            }                                                            
            function updateDowntime(equipmentId, startId, answerId) {
                console.log("Original answerId:", answerId); // Для проверки исходного значения
                const numericAnswerId = parseInt(answerId, 10);
                console.log("Converted numericAnswerId:", numericAnswerId);

                fetch(`/update-downtime/${equipmentId}/${startId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ answer_id: parseInt(answerId, 10) }) // Преобразование в число
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Downtime updated successfully!');
                    } else {
                        throw new Error(data.message || 'Failed to update downtime');
                    }
                })
                .catch(error => console.error('Error updating downtime:', error));
            }                        
        
            let idleTime = 0;
        
            function timerIncrement() {
                idleTime += 1;
                if (idleTime > 5) { // 5 минут бездействия
                    window.location.href = '/logout';
                }
            }
        
            // Обнуление таймера при действиях пользователя
            document.addEventListener('mousemove', resetTimer);
            document.addEventListener('keypress', resetTimer);
        
            function resetTimer() {
                idleTime = 0;
            }
        
            setInterval(timerIncrement, 60000); // Ежеминутная проверка
        </script>        
    </div>
    <a href="/logout" class="home-button">На главную страницу</a>
</body>
</html>
